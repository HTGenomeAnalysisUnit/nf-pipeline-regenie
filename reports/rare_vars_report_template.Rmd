---
title: "Report: `r params$project`"
output:
  rmdformats::robobook:
    self_contained: true
    thumbnails: false
    lightbox: true
    gallery: false
    highlight: tango
params:
  project: test-gwas
  date: 2021-08-09
  version: v0.2
  regenie_merged: /ssu/gassu/shared/regenie_burden_example/caucasians_bmi_age_sex_pcs_cov_chr22_p21001_i0.regenie.gz
  regenie_filename: caucasians_bmi_age_sex_pcs_cov_chr22_p21001_i0.regenie.gz
  phenotype: p21001_i0
  covariates: p21022,PC1,PC2,PC3,PC4,PC5,PC6,PC7,PC8,PC9,PC10,PC11,PC12,PC13,PC14,PC15,PC16,PC17,PC18,PC19,PC20
  phenotype_file: /ssu/gassu/shared/test_new_gwas_pipe/regenie_pheno_input_withPCs.tabsep.tsv
  regenie_step1_log: test-ukbb-quant.step1.log
  regenie_step2_log: test-ukbb-quant.step2.log
  phenotype_log: phenos_quant.pheno.validated.log
  covariate_log: covars.cov.validated.log
  plot_ylimit: 0
  manhattan_annotation_enabled: TRUE
  annotation_min_log10p: 6
  annotated_tophits_filename: Q1.regenie.filtered.annotated.txt.gz
  annotated_toploci_filename: Q1.toploci.annot.tsv
---

```{r}
library(DT)
library(data.table)
library(R.utils)
library(ggplot2)
library(skimr)
library(dplyr)
library(tidyr)
library(ggfastman)
options(DT.options = list(dom = 't'))
```

## Project Summary

| Parameter     | Value                                      |
| ------------- |--------------------------------------------|
| Project       | `r params$project`                         |
| Pipeline Version       | `r params$version`                |
| Date       | `r params$date`                         |
| Phenotype File      | `r params$phenotype_file`            |
| Phenotype       | `r params$phenotype`                     |
| Covariates       | `r params$covariates`                     |
| Regenie Output      | `r params$regenie_filename`             |

## Phenotype Statistics

### Overview

```{r, echo=FALSE}
phenotypeTable <- read.table(params$phenotype_file, header=TRUE, sep="\t", dec = ".")
dt <- as.data.frame(skim(phenotypeTable) %>%
  dplyr::filter(skim_variable == params$phenotype))
dt <- as.data.frame(as.matrix(dt), stringsAsFactors = F)
datatable(dt)
```

### Phenotype distribution

```{r, echo=FALSE}
if (length(unique(na.omit(phenotypeTable[[params$phenotype]]))) == 2) {
  ggplot(phenotypeTable, aes_string(x=params$phenotype)) +
    geom_bar(color="black", fill="white",bins=30) + theme_bw()
} else {
  ggplot(phenotypeTable, aes_string(x=params$phenotype)) +
    geom_histogram(color="black", fill="white",bins=30) + theme_bw()
}
```

## Manhattan plot

This summarises results across all tests and AF bins by plotting only the most significant result for each gene. Note that in case of ties all results with the same pvalue are plotted.

```{r, echo=FALSE}
dt <- fread(params$regenie_merged)
setnames(dt, c("CHROM", "GENPOS", "LOG10P"), c("chr","pos","pvalue"))

dt_clean <- dt %>% 
  #mutate(
  #  ID=gsub("(.+)\\((ENSG[0-9]+)\\)\\.([^.]+)\\.(.+)","\\1@\\2@\\3@\\4", dt$ID) 
  #) %>% 
  separate(ID,c("GENE", "MASK","AFBIN"),sep = '\\.',extra = "merge") %>%
  mutate(rsid = GENE)
```

```{r, fig.height=400, fig.width=400}
dt_top_per_gene <- dt_clean %>%
  group_by(GENE) %>% slice_max(pvalue, n=1)

p1 <- fast_manhattan(
  dt_top_per_gene,log10p = F,
  build='hg19', speed = "f", 
  color1 = "grey", color2 = "orange", pointsize = 2,
  highlight = dt_top_per_gene[dt_top_per_gene$pvalue > 3,]$GENE,
    
) +
  geom_hline(yintercept = 3, linetype ="longdash", color ="firebrick") +
  theme_bw() +
  theme(
      legend.position="none",
      panel.border = element_blank(),
      axis.text = element_text(size = 12,
                               color = "black"),
      axis.title = element_text(size = 14),
      axis.ticks = element_line(color = "black")
      )

# if(!params$manhattan_annotation_enabled) {
#   p2 <- p1
# } else {
#   p2 <- p1 + ggrepel::geom_text_repel(data = . %>% filter(pvalue >= 3) %>% 
#                                         group_by(GENE) %>% slice(1), 
#                              aes(label=GENE), color =1)
# }
p1
```

## Top hits

```{r}
datatable(dt_top_per_gene, options=list(scrollX=T))
```

## Detailed results per model

This section contains detailed results with manhattan plots and QQ plots for each test, mask and AF bin.

<details>
  <summary>Click to see detailed results</summary>

### Manhattan plot

Results are showed separately for each mask and test. All the AF bin levels are shown together for standard burden test.

```{r, fig.height=600, fig.width=600}
fast_manhattan(
  dt_clean,log10p = F,
  build='hg19', speed = "f", 
  color1 = "grey", color2 = "orange", pointsize = 2,
  highlight = dt_clean[dt_clean$pvalue > 7,]$GENE_NAME,
) +
  facet_grid(MASK ~ TEST) +
  geom_hline(yintercept = 7, linetype ="longdash", color ="firebrick") +
  theme_bw()

```

### QQ plot

#### Standard burden test

Results for standard burden test are showed separately for each mask and AF bin.

```{r, fig.height=600, fig.width=600}
df <- dt_clean[!grepl('-', dt_clean$TEST),]
ggplot(df,aes(x=-log10(1:length(pvalue)/length(pvalue)), y=sort(pvalue, decreasing=T))) + geom_point(size=0.5) + geom_abline(slope=1, intercept=0, color="red") + theme_bw() + facet_grid(MASK ~ AFBIN, scales="free") + labs(title="QQ plot for ADD burden test", subtitle="AF BIN x MASK", x="-log10(expected P)", y="-log10(observed P)")
```

#### Other gene tests

Results for other gene tests (SKAT, ACAT, ...) are showed separately for test and mask.

```{r, fig.height=600, fig.width=600}
afbin <- unique(dt_clean %>% filter(TEST != "ADD") %>% pull(AFBIN))
df <- dt_clean[grepl('-', dt_clean$TEST),]
ggplot(df,aes(x=-log10(1:length(pvalue)/length(pvalue)), y=sort(pvalue, decreasing=T))) + geom_point(size=0.5) + geom_abline(slope=1, intercept=0, color="red") + theme_bw() + facet_grid(MASK ~ TEST, scales="free") + labs(title="QQ plot for other gene tests", subtitle="TEST x MASK",x="-log10(expected P)", y="-log10(observed P)")
```

</details>